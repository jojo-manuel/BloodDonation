services:
  # ==========================================
  # BACKEND API SERVICES (Separate per Frontend)
  # ==========================================

  # Login Backend (Port 5001)
  backend-login:
    build:
      context: ./
      dockerfile: backend-login/Dockerfile
    container_name: blood-backend-login
    ports:
      - "5001:3000"
    environment:
      - PORT=3000
      - MONGODB_URI=mongodb://blood-db:27017/blood-monolith
      - JWT_SECRET=${JWT_SECRET:-your-secret-key-change-in-production}
      - JWT_EXPIRES_IN=24h
      - FRONTEND_URL=http://localhost:3000
    depends_on:
      - blood-db
    networks:
      - app-net

  # Admin Backend (Port 5002)
  backend-admin:
    build:
      context: ./
      dockerfile: backend-admin/Dockerfile
    container_name: blood-backend-admin
    ports:
      - "5002:3000"
    environment:
      - PORT=3000
      - MONGODB_URI=mongodb://blood-db:27017/blood-monolith
      - JWT_SECRET=${JWT_SECRET:-your-secret-key-change-in-production}
      - JWT_EXPIRES_IN=24h
      - FRONTEND_URL=http://localhost:3001
    depends_on:
      - blood-db
    networks:
      - app-net

  # Donor Backend (Port 5003)
  backend-donor:
    build:
      context: ./
      dockerfile: backend-donor/Dockerfile
    container_name: blood-backend-donor
    ports:
      - "5003:3000"
    environment:
      - PORT=3000
      - MONGODB_URI=mongodb://blood-db:27017/blood-monolith
      - JWT_SECRET=${JWT_SECRET:-your-secret-key-change-in-production}
      - JWT_EXPIRES_IN=24h
      - FRONTEND_URL=http://localhost:3002
    depends_on:
      - blood-db
    networks:
      - app-net

  # BloodBank Backend (Port 5004)
  backend-bloodbank:
    build:
      context: ./
      dockerfile: backend-bloodbank/Dockerfile
    container_name: blood-backend-bloodbank
    ports:
      - "5004:3000"
    environment:
      - PORT=3000
      - MONGODB_URI=mongodb://blood-db:27017/blood-monolith
      - JWT_SECRET=${JWT_SECRET:-your-secret-key-change-in-production}
      - JWT_EXPIRES_IN=24h
      - SMTP_HOST=${SMTP_HOST:-smtp.gmail.com}
      - SMTP_PORT=${SMTP_PORT:-587}
      - SMTP_USER=${SMTP_USER:-}
      - SMTP_PASS=${SMTP_PASS:-}
      - FRONTEND_URL=http://localhost:3003
    depends_on:
      - blood-db
    networks:
      - app-net

  # ==========================================
  # FRONTEND SERVICES (Each with its own Backend)
  # ==========================================

  # Login / Main App Container (Port 3000) -> Backend Login (5001)
  web-login:
    build:
      context: ../frontend
      dockerfile: Dockerfile
    container_name: blood-frontend-login
    ports:
      - "3000:80"
    environment:
      - VITE_API_URL=http://localhost:5001
    volumes:
      - ./nginx-configs/nginx-login.conf:/etc/nginx/conf.d/default.conf
    depends_on:
      - backend-login
    networks:
      - app-net

  # Admin Dashboard Container (Port 3001) -> Backend Admin (5002)
  web-admin:
    build:
      context: ../frontend
      dockerfile: Dockerfile
    container_name: blood-frontend-admin
    ports:
      - "3001:80"
    environment:
      - VITE_API_URL=http://localhost:5002
    volumes:
      - ./nginx-configs/nginx-admin.conf:/etc/nginx/conf.d/default.conf
    depends_on:
      - backend-admin
    networks:
      - app-net

  # Donor Dashboard Container (Port 3002) -> Backend Donor (5003)
  web-donor:
    build:
      context: ../frontend
      dockerfile: Dockerfile
    container_name: blood-frontend-donor
    ports:
      - "3002:80"
    environment:
      - VITE_API_URL=http://localhost:5003
    volumes:
      - ./nginx-configs/nginx-donor.conf:/etc/nginx/conf.d/default.conf
    depends_on:
      - backend-donor
    networks:
      - app-net

  # Blood Bank Dashboard Container (Port 3003) -> Backend BloodBank (5004)
  web-bloodbank:
    build:
      context: ../frontend
      dockerfile: Dockerfile
    container_name: blood-frontend-bloodbank
    ports:
      - "3003:80"
    environment:
      - VITE_API_URL=http://localhost:5004
    volumes:
      - ./nginx-configs/nginx-bloodbank.conf:/etc/nginx/conf.d/default.conf
    depends_on:
      - backend-bloodbank
    networks:
      - app-net

  # ==========================================
  # DATABASE (Shared)
  # ==========================================
  blood-db:
    image: mongo:6
    container_name: blood-db
    volumes:
      - blood-data:/data/db
    networks:
      - app-net

networks:
  app-net:
    driver: bridge

volumes:
  blood-data:
